name: Generate SBOM

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  generate-sbom:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Generate SBOM with CycloneDX
        run: |
          pip install cyclonedx-bom
          cyclonedx-py requirements requirements.txt -o sbom.json

      - name: Sign SBOM (STaaS)
        shell: bash
        run: |
          set -euo pipefail

          if ! command -v xxd >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y xxd
          fi

          HASH_BASE64=$(sha256sum sbom.json | awk '{print $1}' | xxd -r -p | base64 | tr -d '\n')

          curl -X POST "https://staas.excid.io/API/Sign" \
            -H "Authorization: Bearer ${{ secrets.STAAS_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d @- \
            -o staas.signature.bundle <<JSON
          {
            "HashBase64": "${HASH_BASE64}",
            "Comment": "SBOM signature generated by github action"
          }
          JSON

      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0
      - name: Check install!
        run: cosign version

      - name: Sign SBOM (cosign)
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          cosign sign-blob \
            --yes
            --output-signature cosign.signature.bundle \
            sbom.json
      
      - name: Upload SBOM as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json
          retention-days: 90

      - name: Upload signature bundle as artifact
        uses: actions/upload-artifact@v4
        with:
          name: cosign-signature
          path: cosign.signature.bundle
          retention-days: 90

      - name: Upload cosign signature as artifact
        uses: actions/upload-artifact@v4
        with:
          name: staas-signature
          path: staas.signature.bundle
          retention-days: 90
