name: Generate SBOM

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  generate-sbom:
    runs-on: ubuntu-latest
    env:
      GITHUB_ACTION_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Generate SBOM with CycloneDX
        run: |
          pip install cyclonedx-bom
          cyclonedx-py requirements requirements.txt -o sbom.json

      - name: Sign SBOM (STaaS)
        shell: bash
        run: |
          HASH_HEX=$(sha256sum sbom.json | cut -d ' ' -f1)

          curl -X POST "https://staas.excid.io/API/Sign" \
            -H "Authorization: Bearer ${{ secrets.STAAS_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d @- \
            -o staas.bundle.json <<JSON
          {
            "HashHex": "${HASH_HEX}",
            "Comment": "SBOM signature generated by GitHub Actions: ${GITHUB_ACTION_URL}"
          }
          JSON

      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0
      - name: Check install!
        run: cosign version

      - name: Sign SBOM (cosign)
        run: |
          cosign sign-blob --yes  --bundle cosign.bundle.json sbom.json
            
      
      - name: Upload SBOM as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json
          retention-days: 90

      - name: Upload signature bundle as artifact
        uses: actions/upload-artifact@v4
        with:
          name: cosign.bundle.json
          path: cosign.bundle.json
          retention-days: 90

      - name: Upload cosign signature as artifact
        uses: actions/upload-artifact@v4
        with:
          name: staas.bundle.json
          path: staas.bundle.json
          retention-days: 90
